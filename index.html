<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilador e Divisor de PDF</title>
    <!-- Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca pdf-lib para manipula√ß√£o de PDF no cliente -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para arrastar e soltar */
        #file-list li.dragging {
            opacity: 0.5;
            background: #f0f8ff; /* AliceBlue */
        }
        #file-list li.drag-over-top {
            border-top: 2px solid #3b82f6; /* blue-500 */
        }
        #file-list li.drag-over-bottom {
            border-bottom: 2px solid #3b82f6; /* blue-500 */
        }
        /* Estilos para abas */
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-color: #3b82f6; /* blue-600 */
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-lg m-4">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Ferramenta de PDF</h1>
            <p class="text-gray-500 mt-2">Junte ou separe arquivos PDF e imagens com facilidade.</p>
        </div>

        <!-- Abas de Navega√ß√£o -->
        <div class="flex border-b mb-6">
            <button id="juntar-tab" class="tab-btn py-2 px-4 border-b-2 font-semibold active">Juntar Arquivos</button>
            <button id="separar-tab" class="tab-btn py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-blue-600 font-semibold">Separar PDF</button>
        </div>

        <!-- Conte√∫do da Aba "Juntar" -->
        <div id="juntar-tab-content">
            <p class="text-gray-500 mt-2 text-center mb-6">Carregue, ordene, gire e junte imagens e PDFs em um √∫nico arquivo.</p>
            <!-- √Årea de Upload -->
            <div class="mb-6">
                <label for="file-upload" class="w-full flex flex-col items-center px-4 py-10 bg-white text-blue-500 rounded-lg shadow-md border border-dashed border-blue-300 cursor-pointer hover:bg-blue-50 hover:text-blue-600 transition-colors duration-300">
                    <svg class="w-12 h-12" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3v-4h2v4z" /></svg>
                    <span class="mt-2 text-base font-medium leading-normal">Clique para selecionar os arquivos</span>
                    <input id="file-upload" type="file" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png" />
                </label>
                <p class="text-xs text-gray-500 mt-2 text-center">Tipos suportados: PDF, JPG, PNG.</p>
            </div>
            <!-- Lista de Arquivos -->
            <div id="file-list-container" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-semibold text-gray-700">Arquivos Selecionados:</h2>
                    <button id="clear-btn" class="text-sm bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600 transition-colors">Limpar Lista</button>
                </div>
                <ul id="file-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
            </div>
            <!-- Bot√£o de Compila√ß√£o e Status -->
            <div class="text-center">
                <button id="compile-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">Juntar e Gerar PDF</button>
                <div id="status" class="mt-4 text-sm text-gray-600 h-5"></div>
            </div>
        </div>

        <!-- Conte√∫do da Aba "Separar" -->
        <div id="separar-tab-content" class="hidden">
            <p class="text-gray-500 mt-2 text-center mb-6">Selecione um √∫nico arquivo PDF para extrair p√°ginas espec√≠ficas.</p>
            <!-- √Årea de Upload para Separar -->
             <div class="mb-6">
                <label for="file-upload-split" class="w-full flex flex-col items-center px-4 py-10 bg-white text-blue-500 rounded-lg shadow-md border border-dashed border-blue-300 cursor-pointer hover:bg-blue-50 hover:text-blue-600 transition-colors duration-300">
                    <svg class="w-12 h-12" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3v-4h2v4z" /></svg>
                    <span class="mt-2 text-base font-medium leading-normal">Clique para selecionar um PDF</span>
                    <input id="file-upload-split" type="file" class="hidden" accept=".pdf" />
                </label>
            </div>
            <!-- Nome do arquivo selecionado -->
            <div id="split-file-name" class="text-center text-gray-700 mb-4 h-6 font-medium"></div>
            <!-- Input para p√°ginas -->
            <div class="mb-6">
                <label for="page-range" class="block text-sm font-medium text-gray-700 mb-1">P√°ginas para Extrair:</label>
                <input type="text" id="page-range" placeholder="Ex: 1-3, 5, 8-10" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- Bot√£o de Separa√ß√£o e Status -->
            <div class="text-center">
                <button id="split-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400">Separar e Gerar PDF</button>
                <div id="status-split" class="mt-4 text-sm text-gray-600 h-5"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Pr√©-visualiza√ß√£o -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl max-h-[90vh] overflow-auto relative">
            <button id="close-modal-btn" class="absolute top-2 right-3 text-4xl font-light text-gray-500 hover:text-black z-10">&times;</button>
            <div id="preview-content" class="p-8 flex items-center justify-center">
                <!-- A imagem de pr√©-visualiza√ß√£o ser√° inserida aqui -->
            </div>
        </div>
    </div>


    <script>
        const { PDFDocument, degrees } = PDFLib;

        // --- L√≥gica das Abas ---
        const juntarTab = document.getElementById('juntar-tab');
        const separarTab = document.getElementById('separar-tab');
        const juntarContent = document.getElementById('juntar-tab-content');
        const separarContent = document.getElementById('separar-tab-content');

        juntarTab.addEventListener('click', () => {
            juntarContent.classList.remove('hidden');
            separarContent.classList.add('hidden');
            juntarTab.classList.add('active');
            separarTab.classList.remove('active');
        });

        separarTab.addEventListener('click', () => {
            separarContent.classList.remove('hidden');
            juntarContent.classList.add('hidden');
            separarTab.classList.add('active');
            juntarTab.classList.remove('active');
        });

        // --- L√≥gica de Juntar PDF ---
        const fileUpload = document.getElementById('file-upload');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const compileBtn = document.getElementById('compile-btn');
        const statusDiv = document.getElementById('status');
        const clearBtn = document.getElementById('clear-btn');
        let uploadedFiles = [];
        let draggedItem = null;

        compileBtn.disabled = true;

        function updateFileListUI() {
            fileList.innerHTML = '';
            if (uploadedFiles.length > 0) {
                fileListContainer.classList.remove('hidden');
                compileBtn.disabled = false;
                uploadedFiles.forEach((fileData, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md cursor-move';
                    listItem.setAttribute('draggable', 'true');
                    listItem.setAttribute('data-index', index);
                    
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = `${index + 1}. ${fileData.file.name}`;
                    fileNameSpan.className = 'text-gray-800 text-sm truncate pointer-events-none flex-grow';

                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'flex items-center flex-shrink-0 ml-4';

                    if (fileData.file.type.startsWith('image/')) {
                         const previewBtn = document.createElement('button');
                        previewBtn.innerHTML = 'üëÅÔ∏è';
                        previewBtn.className = 'font-bold text-gray-500 hover:text-gray-700 text-2xl leading-none mr-3';
                        previewBtn.title = 'Pr√©-visualizar Imagem';
                        previewBtn.onclick = () => showPreview(fileData);
                        buttonContainer.appendChild(previewBtn);

                        const rotateBtn = document.createElement('button');
                        rotateBtn.innerHTML = '&#8635;'; // Rotacionar
                        rotateBtn.className = 'font-bold text-blue-500 hover:text-blue-700 text-2xl leading-none';
                        rotateBtn.title = `Girar Imagem`;
                        rotateBtn.onclick = async () => {
                            listItem.style.opacity = '0.5';
                            listItem.style.pointerEvents = 'none';
                            try {
                                const rotatedFile = await rotateImage(fileData.file, 90);
                                fileData.file = rotatedFile;
                            } catch (error) {
                                console.error("Erro ao girar a imagem:", error);
                                statusDiv.textContent = "Erro ao girar a imagem.";
                            } finally {
                                updateFileListUI();
                            }
                        };
                        buttonContainer.appendChild(rotateBtn);
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.className = 'ml-4 font-bold text-red-500 hover:text-red-700 text-xl leading-none';
                    removeBtn.onclick = () => { uploadedFiles.splice(index, 1); updateFileListUI(); };
                    buttonContainer.appendChild(removeBtn);

                    listItem.addEventListener('dragstart', (e) => { draggedItem = listItem; e.dataTransfer.effectAllowed = 'move'; setTimeout(() => listItem.classList.add('dragging'), 0); });
                    listItem.addEventListener('dragover', (e) => { e.preventDefault(); return false; });
                    listItem.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        const target = e.target.closest('li');
                        if (target && target !== draggedItem) {
                            const rect = target.getBoundingClientRect();
                            const midpoint = rect.top + (rect.height / 2);
                            target.classList.remove('drag-over-top', 'drag-over-bottom');
                            target.classList.add(e.clientY < midpoint ? 'drag-over-top' : 'drag-over-bottom');
                        }
                    });
                    listItem.addEventListener('dragleave', (e) => e.target.closest('li')?.classList.remove('drag-over-top', 'drag-over-bottom'));
                    listItem.addEventListener('drop', (e) => {
                        e.stopPropagation();
                        if (draggedItem !== listItem) {
                            const from = Number(draggedItem.getAttribute('data-index'));
                            const to = Number(listItem.getAttribute('data-index'));
                            const item = uploadedFiles.splice(from, 1)[0];
                            uploadedFiles.splice(to, 0, item);
                            updateFileListUI();
                        }
                        return false;
                    });
                    listItem.addEventListener('dragend', () => { document.querySelectorAll('#file-list li').forEach(item => item.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom')); draggedItem = null; });
                    listItem.appendChild(fileNameSpan);
                    listItem.appendChild(buttonContainer);
                    fileList.appendChild(listItem);
                });
            } else {
                fileListContainer.classList.add('hidden');
                compileBtn.disabled = true;
            }
        }

        fileUpload.addEventListener('change', (event) => {
            const newFiles = Array.from(event.target.files).map(file => ({ file: file }));
            uploadedFiles.push(...newFiles);
            updateFileListUI();
            event.target.value = '';
        });

        clearBtn.addEventListener('click', () => {
            uploadedFiles = [];
            statusDiv.textContent = '';
            updateFileListUI();
        });

        compileBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) return;
            statusDiv.textContent = 'Processando...'; compileBtn.disabled = true;
            try {
                const pdfDoc = await PDFDocument.create();
                for (const fileData of uploadedFiles) {
                    const file = fileData.file;
                    statusDiv.textContent = `Processando: ${file.name}`;
                    const buffer = await file.arrayBuffer();
                    if (file.type === 'application/pdf') {
                        const donorPdf = await PDFDocument.load(buffer);
                        const pages = await pdfDoc.copyPages(donorPdf, donorPdf.getPageIndices());
                        pages.forEach(page => pdfDoc.addPage(page));
                    } else if (file.type.startsWith('image/')) {
                        const image = file.type === 'image/png' ? await pdfDoc.embedPng(buffer) : await pdfDoc.embedJpg(buffer);
                        const page = pdfDoc.addPage([image.width, image.height]);
                        page.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: image.width,
                            height: image.height,
                        });
                    }
                }
                statusDiv.textContent = 'Finalizando o PDF...';
                const bytes = await pdfDoc.save();
                download(bytes, "documento_compilado.pdf", "application/pdf");
                statusDiv.textContent = 'PDF gerado com sucesso!';
            } catch (e) { console.error(e); statusDiv.textContent = 'Ocorreu um erro.'; }
            finally { compileBtn.disabled = false; }
        });

        // --- L√≥gica de Separar PDF ---
        const fileUploadSplit = document.getElementById('file-upload-split');
        const splitFileNameDiv = document.getElementById('split-file-name');
        const pageRangeInput = document.getElementById('page-range');
        const splitBtn = document.getElementById('split-btn');
        const statusSplitDiv = document.getElementById('status-split');
        let fileToSplit = null;

        splitBtn.disabled = true;

        fileUploadSplit.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                fileToSplit = event.target.files[0];
                splitFileNameDiv.textContent = `Arquivo: ${fileToSplit.name}`;
                splitBtn.disabled = false;
            } else {
                fileToSplit = null;
                splitFileNameDiv.textContent = '';
                splitBtn.disabled = true;
            }
            event.target.value = '';
        });

        function parsePageRanges(input) {
            const pageNumbers = new Set();
            if (!input) throw new Error("O campo de p√°ginas est√° vazio.");
            const parts = input.replace(/\s/g, '').split(',');
            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    if (isNaN(start) || isNaN(end) || start > end || start < 1) throw new Error(`Intervalo inv√°lido: "${part}"`);
                    for (let i = start; i <= end; i++) pageNumbers.add(i - 1);
                } else {
                    const page = Number(part);
                    if (isNaN(page) || page < 1) throw new Error(`P√°gina inv√°lida: "${part}"`);
                    pageNumbers.add(page - 1);
                }
            }
            return Array.from(pageNumbers).sort((a, b) => a - b);
        }

        splitBtn.addEventListener('click', async () => {
            if (!fileToSplit) { statusSplitDiv.textContent = 'Selecione um arquivo PDF.'; return; }
            statusSplitDiv.textContent = 'Processando...'; splitBtn.disabled = true;
            try {
                const pageIndices = parsePageRanges(pageRangeInput.value);
                const buffer = await fileToSplit.arrayBuffer();
                const sourcePdf = await PDFDocument.load(buffer);
                const totalPages = sourcePdf.getPageCount();
                const invalid = pageIndices.filter(p => p >= totalPages);
                if (invalid.length > 0) throw new Error(`P√°ginas n√£o existem: ${invalid.map(p => p + 1).join(', ')}.`);
                
                const newPdfDoc = await PDFDocument.create();
                const pages = await newPdfDoc.copyPages(sourcePdf, pageIndices);
                pages.forEach(page => newPdfDoc.addPage(page));
                
                const bytes = await newPdfDoc.save();
                download(bytes, `extracao_${fileToSplit.name}`, "application/pdf");
                statusSplitDiv.textContent = 'PDF separado com sucesso!';
            } catch (e) { console.error(e); statusSplitDiv.textContent = `Erro: ${e.message}`; }
            finally { splitBtn.disabled = false; }
        });
        
        // --- L√≥gica da Pr√©-visualiza√ß√£o (Modal) ---
        const previewModal = document.getElementById('preview-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const previewContent = document.getElementById('preview-content');
        let currentPreviewUrl = null;

        function showPreview(fileData) {
            if (currentPreviewUrl) URL.revokeObjectURL(currentPreviewUrl);
            previewContent.innerHTML = '';

            if (fileData.file.type.startsWith('image/')) {
                const img = document.createElement('img');
                currentPreviewUrl = URL.createObjectURL(fileData.file);
                img.src = currentPreviewUrl;
                img.className = 'rounded-md shadow-lg';
                img.style.maxWidth = 'calc(100vw - 8rem)';
                img.style.maxHeight = 'calc(100vh - 8rem)';
                previewContent.appendChild(img);
                previewModal.classList.remove('hidden');
            }
        }

        function closeModal() {
            if (currentPreviewUrl) {
                URL.revokeObjectURL(currentPreviewUrl);
                currentPreviewUrl = null;
            }
            previewModal.classList.add('hidden');
            previewContent.innerHTML = '';
        }

        closeModalBtn.addEventListener('click', closeModal);
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) closeModal();
        });

        // --- Fun√ß√£o para girar a imagem ---
        function rotateImage(file, degrees) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    if (degrees === 90 || degrees === 270) {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }

                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(degrees * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);

                    canvas.toBlob(blob => {
                        const newFile = new File([blob], file.name, { type: file.type, lastModified: Date.now() });
                        URL.revokeObjectURL(url);
                        resolve(newFile);
                    }, file.type);
                };
                img.onerror = reject;
                img.src = url;
            });
        }


        // --- Fun√ß√£o Auxiliar de Download ---
        function download(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>

</body>
</html>
